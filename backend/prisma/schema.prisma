generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id              Int       @id @default(autoincrement())
  name            String
  email           String
  plan            String
  isActive        Boolean   @default(true)
  validUntil      DateTime?
  lineChannelId   String?
  lineSecret      String?
  lineAccessToken String?

  lineSettings             LineSettings?
  reminderMessageTemplates ReminderMessageTemplate[]

  users                  User[]
  customers              Customer[] // ★ 追加
  cars                   Car[] // ★ 追加
  customerRegisterTokens CustomerRegisterToken[]
  messageLogs            MessageLog[]
  bookings               Booking[]

  companyName        String? // 会社名
  companyAddress1    String? // 住所1
  companyAddress2    String? // 住所2
  representativeName String? // 代表者名
  contactPhone       String? // 代表電話
  contactMobile      String? // 担当者携帯など

  broadcastLogs BroadcastLog[]

  // subscriptions   Subscription[] //
  reminderSentLogs ReminderSentLog[]
}

enum Plan {
  BASIC
  STANDARD
  PRO
}

model User {
  id Int @id @default(autoincrement())

  // ★ 開発者は tenantId = null を許可
  tenantId Int?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  email    String  @unique
  name     String?
  password String

  // ★ ロールを追加（開発者 / 管理者 / クライアント）
  role UserRole @default(MANAGER)
  isActive  Boolean  @default(true)
  plan                 Plan?    @default(BASIC)
  maxConcurrentSessions Int      @default(1)

  createdAt DateTime @default(now())
}

enum UserRole {
  DEVELOPER
  MANAGER
  CLIENT
}

model Customer {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  lastName    String
  firstName   String
  postalCode  String?
  address1    String?
  address2    String?
  mobilePhone String?
  lineUid     String?
  //lineSettings   LineSettings?

  // ★ 追加：誕生日
  birthday DateTime?

  cars        Car[]
  messageLogs MessageLog[]
  bookings    Booking[]

  broadcastLogCustomers BroadcastLogCustomer[]
  reminderSentLogs      ReminderSentLog[]

  @@unique([tenantId, lineUid], map: "customer_tenant_lineuid_unique")
  @@unique([tenantId, mobilePhone], map: "customer_tenant_mobile_unique")
}

model CustomerRegisterToken {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  lineUid String // LINEのUID（userId）

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())
}

model Car {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  customerId Int
  customer   Customer @relation(fields: [customerId], references: [id])

  registrationNumber String
  chassisNumber      String
  carName            String

  // ★ 追加：車検・点検・任意日付
  shakenDate         DateTime? // 車検日
  inspectionDate     DateTime? // 点検日
  customReminderDate DateTime? // 任意の日付
  customDaysBefore   Int? // 任意日付の何日前に通知するか

  messageLogs      MessageLog[]
  bookings         Booking[]
  reminderSentLogs ReminderSentLog[]

  @@unique([chassisNumber], map: "car_chassis_unique")
}

enum ReminderMessageType {
  BIRTHDAY
  SHAKEN_TWO_MONTHS
  SHAKEN_ONE_WEEK
  INSPECTION_ONE_MONTH
  CUSTOM
}

enum MessageType {
  // 手動送信用
  MANUAL_CUSTOMER
  MANUAL_CAR

  // 自動リマインド用
  REMINDER_BIRTHDAY
  REMINDER_SHAKEN_2M
  REMINDER_SHAKEN_1W
  REMINDER_INSPECTION_1M
  REMINDER_CUSTOM
}

enum BookingStatus {
  PENDING // 予約申請あり（未確認）
  CONFIRMED // 管理者が承認
  CANCELED // キャンセル（顧客または管理者）
}

enum BroadcastTarget {
  CUSTOMER
  CAR
}

model MessageLog {
  id Int @id @default(autoincrement())

  // ★ テナントとのリレーション
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // ★ 顧客とのリレーション（任意）
  customerId Int?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // ★ 車両とのリレーション（任意）
  carId Int?
  car   Car? @relation(fields: [carId], references: [id])

  lineUid     String?
  messageType MessageType
  content     String

  createdAt DateTime @default(now())
}

model Booking {
  id Int @id @default(autoincrement())

  // マルチテナント
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // 顧客・車両と紐づく
  customerId Int
  customer   Customer @relation(fields: [customerId], references: [id])

  carId Int
  car   Car @relation(fields: [carId], references: [id])

  // 予約日（日時）
  // 最初は「日だけ」で運用してもOKだし、あとで時間も足せる
  bookingDate DateTime // 実際に入庫してほしい日
  timeSlot    String? // 例: "AM", "PM", "10:00-11:00" など自由形式

  status BookingStatus @default(PENDING)

  // どこから来た予約か（LINEフォーム or 管理画面など）
  source String? // "LINE_PUBLIC_FORM" / "ADMIN" など文字で運用

  // 管理用メモ
  note String?

  // ★ 追加：確定LINE送信の履歴
  confirmationLineSentAt  DateTime?
  confirmationLineMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LineSettings {
  id       Int    @id @default(autoincrement())
  tenantId Int    @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // LINE公式アカウントの基本情報
  channelId     String? // チャネルID
  channelSecret String? // チャネルシークレット
  accessToken   String? // 長期アクセストークン
  webhookUrl    String? // 現在LINEに登録しているWebhook URL（表示用）
  destination   String?
  isActive      Boolean @default(false) // このテナントでLINE連携を有効にするか

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReminderMessageTemplate {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  type  ReminderMessageType // ← ここが大事
  title String? // 管理画面での名称とかに使える
  body  String // 実際に送るメッセージ本文
  note  String? // 管理者向けメモ（任意）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, type])
}

model BroadcastLog {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  message     String
  sentCount   Int
  targetCount Int
  createdAt   DateTime @default(now())

  tenant    Tenant                 @relation(fields: [tenantId], references: [id])
  customers BroadcastLogCustomer[] // ★ 追加
  target    BroadcastTarget        @default(CUSTOMER)

  @@index([tenantId, createdAt])
}


model ReminderSentLog {
  id Int @id @default(autoincrement())

  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // 送信したリマインドの対象日（「リマインド日付」）
  date DateTime

  // 種別（誕生日 / 車検2ヶ月前 / 1週間前 / 点検1ヶ月前 / 任意日付）
  category ReminderCategory

  // どの顧客・車に紐づくログか（どちらか片方だけ入るケースもあり）
  customerId Int?
  customer   Customer? @relation(fields: [customerId], references: [id])

  carId Int?
  car   Car? @relation(fields: [carId], references: [id])

  createdAt DateTime @default(now())
}

model BroadcastLogCustomer {
  id             Int          @id @default(autoincrement())
  broadcastLogId Int
  broadcastLog   BroadcastLog @relation(fields: [broadcastLogId], references: [id])

  customerId Int
  customer   Customer @relation(fields: [customerId], references: [id])
}

enum ReminderCategory {
  birthday
  shakenTwoMonths
  shakenOneWeek
  inspectionOneMonth
  custom
}
