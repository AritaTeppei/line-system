import {
  Body,
  Controller,
  Get,
  Post,
  Req,
  UnauthorizedException,
} from '@nestjs/common';
import type { Request } from 'express'; // ★ TS1272 対策で type import
import { AuthService, AuthPayload } from './auth.service';

@Controller('auth')
export class AuthController {
  constructor(private readonly auth: AuthService) {}

  /**
   * ログインAPI
   * POST /auth/login
   * body: { email, password }
   * 戻り値: { token, email, tenantId, role }
   */
    @Post('login')
  async login(@Body() body: { email: string; password: string }) {
    const { email, password } = body;

    if (!email || !password) {
      throw new UnauthorizedException('メールアドレスとパスワードが必要です');
    }

    // ★ ユーザー検証 + テナント有効チェックをまとめて実行
    const { user, payload } = await this.auth.validateUserWithTenantCheck(
      email,
      password,
    );

    // ★ 問題なければトークン発行
    const token = this.auth.issueToken(payload);

    // フロント用に token と最低限の情報を返す
    return {
      token,
      email: user.email,
      tenantId: user.tenantId ?? null,
      role: user.role,
      // 必要なら name も返してOK
      // name: (user as any).name ?? null,
    };
  }


  /**
   * 自分のパスワード変更
   * POST /auth/change-password
   *
   * - MANAGER / DEVELOPER は利用可能
   * - CLIENT は禁止
   */
  @Post('change-password')
  async changePassword(
    @Req() req: Request,
    @Body()
    body: {
      currentPassword: string;
      newPassword: string;
      confirmNewPassword: string;
    },
  ) {
    // まずJWTからログイン中のユーザー情報を取り出す（今の /auth/me と同じやり方）
    const payload = await this.auth.getPayloadFromRequestWithTenantCheck(req);

    // CLIENT は自身でパスワード変更させない仕様
    if (payload.role === 'CLIENT') {
      throw new UnauthorizedException(
        'CLIENT は自身のパスワードを変更できません。管理者にお問い合わせください。',
      );
    }

    await this.auth.changeOwnPassword({
      userId: payload.id,
      currentPassword: body.currentPassword,
      newPassword: body.newPassword,
      confirmNewPassword: body.confirmNewPassword,
    });

    return { ok: true };
  }

    /**
   * MANAGER が CLIENT のパスワードを強制変更する
   * POST /auth/manager/reset-client-password
   */
  @Post('manager/reset-client-password')
  async managerResetClientPassword(
    @Req() req: Request,
    @Body()
    body: {
      clientUserId: number;
      newPassword: string;
      confirmNewPassword: string;
    },
  ) {
    // JWT からログイン中ユーザー情報を取得（/auth/me と同じスタイル）
    const payload = await this.auth.getPayloadFromRequestWithTenantCheck(req);

    // MANAGER 以外は弾く（仕様どおり）
    if (payload.role !== 'MANAGER') {
      throw new UnauthorizedException(
        'MANAGER のみが CLIENT のパスワードを変更できます。',
      );
    }

    await this.auth.managerResetClientPassword(payload, {
      clientUserId: body.clientUserId,
      newPassword: body.newPassword,
      confirmNewPassword: body.confirmNewPassword,
    });

    return { ok: true };
  }

  /**
   * 誰がログインしているか（JWTから復元）
   * GET /auth/me
   */
  @Get('me')
  async me(@Req() req: Request) {
    const payload = await this.auth.getPayloadFromRequestWithTenantCheck(req);

    // 返す形（AuthPayload）は今まで通り
    return payload;
  }
}
